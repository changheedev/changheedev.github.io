---

title: NCP에서 HA 구성해보기

categories: [Programming, DevOps]

tags: [DevOps, Ubuntu, HA, NCP]

---



부스트캠프에서 팀프로젝트를 하면서 HAProxy를 이용한 로드밸런싱을 구현했었는데 실제 서비스에서는 안정성을 위해 Proxy 서버를 이중화하여 **HA(High Availability)**를 구성한다고 한다.

HA 구성에 대한 자료를 찾아보니 마침 NCP(네이버 클라우드 플랫폼) 환경에서 HA를 구성하는 방법이 있었는데 직접 적용해보면서 그 과정을 정리하려고 한다. (하루 남은 크레딧도 알차게 사용할겸..)



이 방법은 Keepalived를 이용한다. 

### Keepalived

- 가상 IP를 기반으로 서버를 다중화하는 도구
- Master 서버를 모니터링하다 해당 노드에 장애가 발생했을 시, Backup 서버로 Failover



<br> 

## 1. Server 생성

Master, Backup 서버로 사용할 서버 2대와 테스트용 서버 1대를 NCP에서 생성해준다.

실제 서비스용이 아닌 실습용 서버이므로 적당한 사양의 서버를 생성했으며, 생성한 서버의 사양은 아래와 같다.

- Ubuntu 18.04

- [Compact] 1vCPU, 2GB Mem, 50GB Disk [g1]



그 다음 추가 인터페이스를 할당해주어야 하는데, 그 이유는 NCP에서는 eth0에 IP alias를 사용할 경우, IP Spoofing으로 인식하고 해당 VM의 네트워크 통신을 끊어버리기 때문이라고 한다.



<br> 

## 2. Private subnet 생성

NCP에서는 Zone 당 하나의 서브넷 생성만 가능하다. 서브넷에서 세번째 옥텟의 비트가 8개 이므로 1~254까지의 범위중 하나를 골라 서브넷을 생성해준다.

![스크린샷 2020-12-30 오후 2 50 07](https://user-images.githubusercontent.com/17294694/103337577-2bdc5100-4abf-11eb-8e55-7a151f123213.png)



<br> 

## 3. 인터페이스 할당

인터페이스 설정은 NCP의 **Network Interface** 메뉴에서 지원한다.

위에서 생성한 서브넷을 이용하여 각 서버에 인터페이스를 할당해준다.

![스크린샷 2020-12-30 오후 3 31 06](https://user-images.githubusercontent.com/17294694/103337618-46162f00-4abf-11eb-94de-fbaad3992824.png)



그 다음 서버로 접속(SSH) 하여 인터페이스를 활성화 해준다. (모든 서버에 적용해준다)

**인터페이스 설정**

```
sudo nano /etc/network/interfaces

# The secondary network interface
auto eth1
iface eth1 inet static
address <NCP에서 설정한 IP 주소>
netmask 255.255.255.0
```



**인터페이스 활성화**

```
sudo ifup eth1
```



인터페이스가 제대로 활성화 된 경우 ifconfig 명령을 사용했을 때 아래와 같이 eth1 인터페이스가 보여진다.

![스크린샷 2020-12-30 오후 3 21 41](https://user-images.githubusercontent.com/17294694/103337884-f6843300-4abf-11eb-9799-eb41961c76cf.png)



<br> 

## 4. VIP(Virtual IP) 할당

Master, Backup 서버에 IP Alias를 설정하여 VIP로 접근할 수 있도록 한다.

**VIP 설정**

```
sudo nano /etc/network/interfaces

# VIP
auto eth1:0
iface eth1:0 inet static
address <사용할 VIP>
netmask 255.255.255.0
```



**VIP 활성화**

```
sudo ifup eth1:0
```



![스크린샷 2020-12-30 오후 3 23 22](https://user-images.githubusercontent.com/17294694/103337890-fd12aa80-4abf-11eb-8f6c-34c9eaa00a54.png)



<br> 

## 5. Keepalived 설정

Master, Backup 서버에 Keepalived 를 설치해준다.

```
sudo apt-get update
sudo apt-get install keepalived
```



설치를 마친후, Keepalived 설정 파일을 수정한다.

```
sudo nano /etc/keepalived/keepalived.conf
```



**Master**

```
vrrp_instance VI_1 {
	state MASTER
	interface eth1
	virtual_router_id 51
	priority 200
	advert_int 1
	authentication {
		auth_type PASS
		auth_pass pass1234
	}
	virtual_ipaddress {
		192.168.200.102
	}
}
```



**Backup**

```
vrrp_instance VI_1 {
	state BACKUP
	interface eth1
	virtual_router_id 51
	priority 100
	advert_int 1
	authentication {
		auth_type PASS
		auth_pass pass1234
	}
	virtual_ipaddress {
		192.168.200.102
	}
}
```



**주의할 점**

- Master 서버의  Priority를 Backup 서버보다 더 높게 설정해주어야 한다. 
  (priority값이 더 높은 쪽이 Master서버가 된다.)
- auth_pass, virtual_router 값은 Master, Backup 서버 모두 동일해야 한다.



설정이 완료되면 keepalived를 실행한다.

```
sudo service keepalived start
```



<br> 

## 6. HA 테스트

실제로 keepalived가 잘 실행되는지 확인해보기 위해 테스트 서버에서 VIP로 Ping을 날려본다.

```
ping 192.168.200.102
```



네트워크 설정이 제대로 되었다면 아래와 같이 응답이 도착하게 된다.

![스크린샷 2020-12-30 오후 5 00 23](https://user-images.githubusercontent.com/17294694/103338072-917d0d00-4ac0-11eb-9581-1a9ac5fc47be.png)

Master 서버에서 reboot 명령을 실행하여 down 상태로 만들고, Ping 응답이 유지되는지 확인한다.

![스크린샷 2020-12-30 오후 4 46 34](https://user-images.githubusercontent.com/17294694/103338009-5a0e6080-4ac0-11eb-960d-6898adcc1245.png)

![스크린샷 2020-12-30 오후 4 46 59](https://user-images.githubusercontent.com/17294694/103338124-bbceca80-4ac0-11eb-94ab-75dcd86e09ab.png)

Backup 서버의 로그를 확인해보면 아래와 같이 Master 상태로 변경된 것을 확인할 수 있다.

![스크린샷 2020-12-30 오후 4 46 38](https://user-images.githubusercontent.com/17294694/103341156-6f3bbd00-4ac9-11eb-9143-dd8a266ff7d7.png)

이 상태에서 Master로 승격된 Backup 서버도 down 상태로 만들면, Ping이 전달되지 않는 것을 확인할 수 있다.

![스크린샷 2020-12-30 오후 4 45 07](https://user-images.githubusercontent.com/17294694/103337960-33502a00-4ac0-11eb-8873-bab740c7af0e.png)



리붓이 완료되어 서버가 재실행되면 Ping이 다시 전달된다.

![스크린샷 2020-12-30 오후 4 47 33](https://user-images.githubusercontent.com/17294694/103337948-27646800-4ac0-11eb-89a2-f9f94de96995.png)



<br> 

## References

[https://navercloudplatform.medium.com](https://navercloudplatform.medium.com/keepalived%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%98%EC%97%AC-%EA%B0%84%EB%8B%A8%ED%95%98%EA%B2%8C-ha-%EA%B5%AC%EC%84%B1%ED%95%B4%EB%B3%B4%EA%B8%B0-c840b90149a5)

